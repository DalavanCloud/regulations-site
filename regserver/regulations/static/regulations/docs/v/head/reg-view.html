<!DOCTYPE html>

<html>
<head>
  <title>reg-view.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app-init.html">
                app-init.js
              </a>
            
              
              <a class="source" href="build.html">
                build.js
              </a>
            
              
              <a class="source" href="dispatch.html">
                dispatch.js
              </a>
            
              
              <a class="source" href="folder-model.html">
                folder-model.js
              </a>
            
              
              <a class="source" href="meta-model.html">
                meta-model.js
              </a>
            
              
              <a class="source" href="reg-model.html">
                reg-model.js
              </a>
            
              
              <a class="source" href="regs-helpers.html">
                regs-helpers.js
              </a>
            
              
              <a class="source" href="regs-router.html">
                regs-router.js
              </a>
            
              
              <a class="source" href="regulations.html">
                regulations.js
              </a>
            
              
              <a class="source" href="require.config.html">
                require.config.js
              </a>
            
              
              <a class="source" href="search-model.html">
                search-model.js
              </a>
            
              
              <a class="source" href="sxs-model.html">
                sxs-model.js
              </a>
            
              
              <a class="source" href="analytics-handler-view.html">
                analytics-handler-view.js
              </a>
            
              
              <a class="source" href="definition-view.html">
                definition-view.js
              </a>
            
              
              <a class="source" href="drawer-view.html">
                drawer-view.js
              </a>
            
              
              <a class="source" href="header-view.html">
                header-view.js
              </a>
            
              
              <a class="source" href="history-view.html">
                history-view.js
              </a>
            
              
              <a class="source" href="main-view.html">
                main-view.js
              </a>
            
              
              <a class="source" href="permalink-view.html">
                permalink-view.js
              </a>
            
              
              <a class="source" href="reg-view.html">
                reg-view.js
              </a>
            
              
              <a class="source" href="search-results-view.html">
                search-results-view.js
              </a>
            
              
              <a class="source" href="search-view.html">
                search-view.js
              </a>
            
              
              <a class="source" href="section-footer-view.html">
                section-footer-view.js
              </a>
            
              
              <a class="source" href="sidebar-head-view.html">
                sidebar-head-view.js
              </a>
            
              
              <a class="source" href="sidebar-list-view.html">
                sidebar-list-view.js
              </a>
            
              
              <a class="source" href="sidebar-module-view.html">
                sidebar-module-view.js
              </a>
            
              
              <a class="source" href="sidebar-view.html">
                sidebar-view.js
              </a>
            
              
              <a class="source" href="sub-head-view.html">
                sub-head-view.js
              </a>
            
              
              <a class="source" href="sxs-list-view.html">
                sxs-list-view.js
              </a>
            
              
              <a class="source" href="sxs-view.html">
                sxs-view.js
              </a>
            
              
              <a class="source" href="toc-view.html">
                toc-view.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>reg-view.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><strong>Extends</strong> Backbone.View</p>
<p><strong>Jurisdiction</strong> .main-content</p>
<p><strong>Usage</strong> <code>require([&#39;reg-view&#39;], function(RegView) {})</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define(<span class="string">'reg-view'</span>, [<span class="string">'jquery'</span>, <span class="string">'underscore'</span>, <span class="string">'backbone'</span>, <span class="string">'jquery-scrollstop'</span>, <span class="string">'dispatch'</span>, <span class="string">'definition-view'</span>, <span class="string">'reg-model'</span>, <span class="string">'section-footer-view'</span>, <span class="string">'regs-router'</span>], <span class="keyword">function</span>($, _, Backbone, jQScroll, Dispatch, DefinitionView, RegModel, SectionFooterView, Router) {
    <span class="string">'use strict'</span>;

    <span class="keyword">var</span> RegView = Backbone.View.extend({
        el: <span class="string">'#content-wrapper'</span>,

        events: {
            <span class="string">'click .definition'</span>: <span class="string">'termLinkHandler'</span>,
            <span class="string">'click .inline-interp-header'</span>: <span class="string">'expandInterp'</span>,
            <span class="string">'click .definition.active'</span>: <span class="string">'openDefinitionLinkHandler'</span>,
            <span class="string">'click .inline-interpretation .section-link'</span>: <span class="string">'openInterp'</span>
        },

        initialize: <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong>Event Listeners</strong></p>
<ul>
<li>when a definition is removed, update term links</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Dispatch.on(<span class="string">'definition:remove'</span>, <span class="keyword">this</span>.closeDefinition, <span class="keyword">this</span>);

            Dispatch.on(<span class="string">'breakaway:open'</span>, <span class="keyword">this</span>.hideContent, <span class="keyword">this</span>);
            Dispatch.on(<span class="string">'breakaway:close'</span>, <span class="keyword">this</span>.showContent, <span class="keyword">this</span>);

            Dispatch.set(<span class="string">'section'</span>, <span class="keyword">this</span>.options.id);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <ul>
<li>when a scroll event completes, check what the active secion is</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            $(window).on(<span class="string">'scrollstop'</span>, (_.bind(<span class="keyword">this</span>.checkActiveSection, <span class="keyword">this</span>)));</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>set active section vars
@TODO: how do activeSection and Dispatch.get(&#39;section&#39;) live together?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.activeSection = <span class="keyword">this</span>.options.id || <span class="string">''</span>;
            <span class="keyword">this</span>.$activeSection = <span class="string">''</span>;
            <span class="keyword">this</span>.$sections = {};

            <span class="keyword">this</span>.updateWayfinding();

            <span class="keyword">if</span> (Dispatch.hasPushState()) {
                <span class="keyword">var</span> url = <span class="keyword">this</span>.options.id + <span class="string">'/'</span> + Dispatch.getVersion(),
                    hashPosition = (<span class="keyword">typeof</span> Backbone.history.fragment === <span class="string">'undefined'</span>) ? -<span class="number">1</span> : Backbone.history.fragment.indexOf(<span class="string">'#'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p> Be sure not to lose any hash info</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (hashPosition !== -<span class="number">1</span>) {
                    url = url + Backbone.history.fragment.substr(hashPosition);
                }
                Router.navigate(url);
            }

            Dispatch.set(<span class="string">'sectionNav'</span>, <span class="keyword">new</span> SectionFooterView({el: <span class="keyword">this</span>.$el.find(<span class="string">'.section-nav'</span>)}));

            Dispatch.trigger(<span class="string">'regSection:open:after'</span>, <span class="keyword">this</span>.options.id);

        },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>naive way to update the active table of contents link and wayfinding header
once a scroll event ends, we loop through each content section DOM node
the first one whose offset is greater than the window scroll position, accounting
for the fixed position header, is deemed the active section</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        checkActiveSection: <span class="keyword">function</span>() {
            <span class="keyword">var</span> len = <span class="keyword">this</span>.$contentContainer.length - <span class="number">1</span>;

            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= len; i++) {
                <span class="keyword">if</span> (<span class="keyword">this</span>.$sections[i].offset().top + <span class="keyword">this</span>.$contentHeader.height() &gt;= $(window).scrollTop()) {
                    <span class="keyword">if</span> (_.isEmpty(<span class="keyword">this</span>.activeSection) || (<span class="keyword">this</span>.activeSection !== <span class="keyword">this</span>.$sections[i].id)) {
                        <span class="keyword">this</span>.activeSection = <span class="keyword">this</span>.$sections[i][<span class="number">0</span>].id;
                        <span class="keyword">this</span>.$activeSection = <span class="keyword">this</span>.$sections[i][<span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><strong>Event</strong> trigger active section change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        Dispatch.trigger(<span class="string">'activeSection:change'</span>, <span class="keyword">this</span>.activeSection);
                        <span class="keyword">return</span>;
                    }
                }
            }
                 
            <span class="keyword">return</span> <span class="keyword">this</span>;
        },

        updateWayfinding: <span class="keyword">function</span>() {
            <span class="keyword">var</span> i, len;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>cache all sections in the DOM eligible to be the active section
also cache some jQobjs that we will refer to frequently</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.$contentHeader = <span class="keyword">this</span>.$contentHeader || $(<span class="string">'header.reg-header'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>sections that are eligible for being the active section</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.$contentContainer = <span class="keyword">this</span>.$el.find(<span class="string">'.level-1 li[id], .reg-section, .appendix-section, .supplement-section'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>cache jQobjs of each reg section</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            len = <span class="keyword">this</span>.$contentContainer.length;
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) {
                <span class="keyword">this</span>.$sections[i] = $(<span class="keyword">this</span>.$contentContainer[i]);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>only concerned with resetting DOM, no matter
what way the definition was closed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        closeDefinition: <span class="keyword">function</span>() {
            <span class="keyword">this</span>.clearActiveTerms();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>only concerned with sending GA event if the definition
is closed via active term link</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        openDefinitionLinkHandler: <span class="keyword">function</span>(e) {
            Dispatch.trigger(<span class="string">'ga-event:definition'</span>, {
                action: <span class="string">'clicked key term to close definition'</span>,
                context: $(e.target).data(<span class="string">'definition'</span>)
            });
        },

        toggleDefinition: <span class="keyword">function</span>($link) {
            <span class="keyword">this</span>.setActiveTerm($link); 

            <span class="keyword">return</span> <span class="keyword">this</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>content section key term link click handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        termLinkHandler: <span class="keyword">function</span>(e) {
            e.preventDefault();

            <span class="keyword">var</span> $link = $(e.target),
                defId = $link.attr(<span class="string">'data-definition'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>if this link is already active, toggle def shut</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> ($link.data(<span class="string">'active'</span>)) {
                Dispatch.remove(<span class="string">'definition'</span>);
                <span class="keyword">this</span>.clearActiveTerms();
            }
            <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>if its the same definition, diff term link</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (Dispatch.getViewId(<span class="string">'definition'</span>) === defId) {
                    <span class="keyword">this</span>.toggleDefinition($link);
                }
                <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>close old definition, if there is one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    Dispatch.remove(<span class="string">'definition'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>open new definition</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">this</span>.openDefinition(defId, $link);
                }
            }

            <span class="keyword">return</span> <span class="keyword">this</span>;
        },

        openDefinition: <span class="keyword">function</span>(defId, $link) {
            <span class="keyword">var</span> definition = <span class="keyword">new</span> DefinitionView({
                id: defId,
                $anchor: $link
            });

            Dispatch.set(<span class="string">'definition'</span>, definition);
            Dispatch.trigger(<span class="string">'definition:open'</span>);
            Dispatch.trigger(<span class="string">'ga-event:definition'</span>, {
                action: <span class="string">'clicked key term to open definition'</span>,
                context: defId
            });
            <span class="keyword">this</span>.setActiveTerm($link);

            <span class="keyword">return</span> definition;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>handler for when inline interpretation is clicked</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        expandInterp: <span class="keyword">function</span>(e) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>user can click anywhere in the header of a closed interp
for an open interp, they can click &quot;hide&quot; button or header</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            e.stopPropagation();
            e.preventDefault();
            <span class="keyword">var</span> header = $(e.currentTarget),
                section = header.parent(),
                button = header.find(<span class="string">'.expand-button'</span>),
                buttonText = header.find(<span class="string">'.expand-text'</span>);

            section.toggleClass(<span class="string">'open'</span>);
            header.next(<span class="string">'.hidden'</span>).slideToggle();
            button.toggleClass(<span class="string">'open'</span>);
            buttonText.html(section.hasClass(<span class="string">'open'</span>) ? <span class="string">'Hide'</span> : <span class="string">'Show'</span>);

            <span class="keyword">return</span> <span class="keyword">this</span>;
        },

        changeFocus: <span class="keyword">function</span>(id) {
            $(id).focus();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Sets DOM back to neutral state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        clearActiveTerms: <span class="keyword">function</span>() {
            <span class="keyword">this</span>.$el.find(<span class="string">'.active.definition'</span>)
                .removeClass(<span class="string">'active'</span>)
                .removeData(<span class="string">'active'</span>);
        },

        setActiveTerm: <span class="keyword">function</span>($link) {
            <span class="keyword">this</span>.clearActiveTerms();
            $link.addClass(<span class="string">'active'</span>).data(<span class="string">'active'</span>, <span class="number">1</span>);
        },

        openInterp: <span class="keyword">function</span>(e) {
            e.preventDefault();

            <span class="keyword">var</span> sectionId = $(e.currentTarget).data(<span class="string">'linked-section'</span>),
                subSectionId = $(e.currentTarget).data(<span class="string">'linked-subsection'</span>);
            
            Router.navigate(sectionId + <span class="string">'/'</span> + Dispatch.getVersion() + <span class="string">'#'</span> + subSectionId, {trigger: <span class="literal">true</span>});
        },

        remove: <span class="keyword">function</span>() {
            Dispatch.get(<span class="string">'sectionNav'</span>).remove();
            Dispatch.remove(<span class="string">'sectionNav'</span>);
            <span class="keyword">this</span>.$el.remove();
            <span class="keyword">this</span>.stopListening();
            <span class="keyword">return</span> <span class="keyword">this</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>when breakaway view loads</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        hideContent: <span class="keyword">function</span>() {
            <span class="keyword">this</span>.$el.fadeOut(<span class="number">1000</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>when breakaway view unloads</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        showContent: <span class="keyword">function</span>() {
            <span class="keyword">this</span>.$el.fadeIn();
        }
    });

    <span class="keyword">return</span> RegView;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
